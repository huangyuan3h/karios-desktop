# Watchlist 评分与止损逻辑说明

## 一、Score（分数，0-100分）

**目标**：评估未来1-2交易日的操作分数，偏好强趋势 + 动量 + 成交量确认 + 有限风险。

**计算公式**：

```
Score = (EMA分 + MACD分 + 突破分 + RSI分 + 成交量分 + 新高奖励 + 高动量奖励 + ATR高弹性奖励) - (ATR波动率惩罚 + EMA20下方惩罚)
最终分数 = max(0, min(100, Score))
```

### 1. 正向得分项（总分100分）

#### EMA趋势分（25分，权重0.25）

- EMA5 > EMA20：+12.5分
- EMA20 > EMA60：+12.5分
- 两项都满足：25分

#### MACD动量分（20分，权重0.20）

- **前提**：MACD线 > 0
- **计算**：取最近4天的MACD柱状图（histogram），只考虑正值部分
- **条件**：最近3次比较中，至少2次递增，且最新histogram > 0
- **强度门槛**：histogram绝对值需 >= 0.0005 \* 当前收盘价（避免微小波动得分）
- **得分**：满足条件时 = 0.5 + 0.5 \* (递增次数/3)

#### 突破分（20分，权重0.20）

- **计算**：close / high20（最近20天最高价）
- **得分**：在[0.85, 0.95]区间内线性映射到[0, 1]
- **新高奖励**：如果 close >= high20，额外+3分

#### RSI质量分（15分，权重0.15）

- **条件**：RSI14在[50, 75]区间内
- **得分**：三角偏好函数，峰值在62.5
  - 公式：1.0 - abs(RSI14 - 62.5) / 12.5
  - RSI14 = 62.5时得分最高
- **RSI > 75**：不扣分，保持峰值得分（15分），视为强动量

#### 成交量确认分（20分，权重0.20）

- **计算**：avgVol5 / avgVol30（5日均量 / 30日均量）
- **得分**：在[1.0, 1.3]区间内线性映射到[0, 1]

#### 高动量奖励（+5分）

- **条件**：RSI14 > 75 且 成交量放大（avgVol5 / avgVol30 > 1.2）
- **说明**：RSI超买但成交量放大，视为高动量突破，额外奖励5分

### 2. 风险惩罚项（扣分）

#### 波动率相对分（ATR相对评分）

**逻辑**：高波动率在趋势向上时是加分项（高弹性），在趋势向下时是扣分项（高风险）

- **趋势向上**（Close > EMA20 且 MACD扩张）：
  - **高弹性奖励**：ATR(14) / 当前收盘价
  - **映射**：[0.015, 0.05]区间线性映射到[0, 10]分奖励
  - **说明**：对于科技/AI等高成长性股票（如CPO板块），高波动率意味着高弹性，有更大的上涨空间
- **趋势向下**（Close < EMA20 或 MACD未扩张）：
  - **波动率惩罚**：ATR(14) / 当前收盘价
  - **映射**：[0.015, 0.05]区间线性映射到[0, 10]分惩罚
  - **说明**：趋势向下时，高波动率意味着高风险，需要重罚

#### EMA20下方惩罚（最多-10分）

- **条件**：当前收盘价 < EMA20
- **计算**：(EMA20 - close) / EMA20
- **映射**：每低于EMA20 5%，扣10分（线性，最多扣10分）

---

## 二、TrendOK（趋势是否良好）

**判断逻辑**：需要**全部6个条件**都为True，TrendOK才为True。如果任何条件为None（数据不足），TrendOK返回None。

### 6个必检条件

1. **EMA顺序** (`emaOrder`)
   - 条件：EMA5 > EMA20 > EMA60
   - 说明：短期均线在上，长期均线在下，形成多头排列

2. **MACD正值** (`macdPositive`)
   - 条件：MACD线 > 0
   - 说明：MACD处于零轴上方，趋势向上

3. **MACD柱扩张** (`macdHistExpanding`)
   - 条件：
     - 最近4天的MACD柱状图（histogram）中，只考虑正值部分
     - 最近3次比较中，至少2次递增
     - 最新histogram > 0
   - 说明：动量在增强，上涨动能持续

4. **接近20日高点** (`closeNear20dHigh`)
   - 条件：close >= 0.95 \* high20（收盘价 >= 最近20天最高价的95%）
   - 说明：价格接近近期高点，处于强势区域

5. **RSI合理区间** (`rsiInRange`)
   - 条件：50 <= RSI14 <= 85
   - 说明：既不过热（<85），也不弱势（>50），处于健康上涨区间（上限从75放宽至85）

6. **成交量放大** (`volumeSurge`)
   - 条件：avgVol5 > 1.0 \* avgVol30 **OR** close >= high20（5日均量 > 30日均量 **或** 收盘价创20日新高）
   - 说明：
     - 成交量放大：近期成交量放大，有资金关注
     - 缩量上涨：如果价格已创新高，即使成交量未放大20%也认可（龙头股筹码锁定后缩量上涨是强势形态）
     - 逻辑：每天要求放量20%往往是头部出货特征；创新高时量能稍小说明抛压轻，是健康上涨

---

## 三、止损（Stop Loss）

**公式**：`stop_loss = max(final_support - atr_k * ATR14, current * (1 - max_loss_pct))`

### 1. 立即离场信号（exit_now = True）

如果触发以下任一条件，止损价 = 当前价格，显示"立刻离场"：

#### 条件1：趋势结构破坏

- **EMA5 < EMA20** 或 **收盘价 < EMA20**
- 说明：短期趋势转弱，建议立即离场

#### 条件2：动量衰竭 + 成交量萎缩

- **MACD柱状图**：最近4天中，hist[-4] > hist[-3] > hist[-2] > 0 且 hist[-1] < 0（连续缩小3天后转负）
- **成交量**：avgVol5 < avgVol30（5日均量 < 30日均量）
- 说明：动量耗尽且资金撤离，建议立即离场

### 2. 警告信号（warn_reduce_half = True）

如果MACD柱状图连续缩小但**尚未转负**，且成交量萎缩，显示警告：

- **条件**：最近4天中，至少2次递减，且最新histogram > 0，且avgVol5 < avgVol30
- **建议**：至少卖出一半仓位

### 3. 正常止损计算（exit_now = False）

#### 步骤1：计算支撑位（final_support）

1. **摆动低点**（swing_low_10d）：最近10天的最低价
2. **平台低点**（platform_low_20d_excl_5d）：最近20天（排除最近5天）的最低价
3. **EMA20**：20日指数移动平均线
4. **结构支撑**：max(swing_low, platform_low, ema20)
5. **筹码支撑**（可选）：如果筹码分布的平均成本 < 当前价，则 final_support = max(structural_support, avgCost \* 0.99)

#### 步骤2：根据波动率确定参数

根据最近20天收益率的标准差（vol_std20）分类：

| 波动率分类 | vol_std20范围 | ATR倍数(atr_k) | 最大亏损比例(max_loss_pct) |
| ---------- | ------------- | -------------- | -------------------------- |
| 低波动     | <= 0.02       | 1.1            | 6%                         |
| 中波动     | 0.02 ~ 0.04   | 1.2            | 8%                         |
| 高波动     | > 0.04        | 1.4            | 10%                        |
| 未知       | 无法计算      | 1.2            | 8%                         |

#### 步骤3：计算最终止损价

```
buffer = atr_k * ATR14
hard_stop = current * (1 - max_loss_pct)  // 硬止损（最大亏损比例）
stop_loss_support = final_support - buffer  // 支撑位减去缓冲
final_stop = max(stop_loss_support, hard_stop)  // 取两者较大值
final_stop = min(final_stop, current)  // 不超过当前价
```

**说明**：

- `stop_loss_support`：基于支撑位和ATR缓冲的动态止损
- `hard_stop`：基于最大亏损比例的硬止损
- 最终止损取两者较大值，确保不会超过当前价格

---

## 四、买入建议（Buy Action）

### 买入模式

#### Mode A：突破回踩（A_pullback）

- **条件**：已突破但当前不在趋势中（EMA20未上升或MACD柱为负）
- **买入区**：EMA20附近
- **动作**：等待回踩EMA20时买入

#### Mode B：动量新高（B_momentum）

- **条件**：处于趋势中（close > EMA20 且 EMA20上升 且 MACD柱 > 0）
- **买入区**：新高附近（high20 _ 0.98 ~ high20 _ 1.02）
- **动作**：接近或创新高时买入

### 买入动作

- **wait**：等待合适时机
- **buy**：可以买入
- **add**：可以加仓
- **avoid**：回避（触发exit_now时）

---

## 五、数据要求

### 最小数据量

- **Score计算**：需要至少60根日K线
- **TrendOK判断**：需要至少60根日K线（部分指标需要30-60根）
- **止损计算**：需要至少20根日K线（理想情况60根以上）

### 缺失数据处理

- 如果关键指标缺失，Score返回None（UI显示"—"）
- 如果TrendOK的任一必检条件为None，TrendOK返回None
- 如果止损计算所需数据不足，stopLossPrice返回None

---

## 六、使用建议

1. **Score > 70**：高优先级，趋势和动量都较强
2. **TrendOK = True**：6个条件全部满足，趋势健康
3. **止损价**：
   - 如果显示"立刻离场"：立即卖出
   - 如果显示警告：考虑减仓一半
   - 正常止损：价格跌破止损价时卖出
4. **买入时机**：结合Score、TrendOK和买入建议（buyAction）综合判断

---

**最后更新**：2025-01-28
**代码位置**：`services/quant-service/main.py` -> `_market_stock_trendok_one()`
